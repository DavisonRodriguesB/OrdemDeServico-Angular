<div
  *ngIf="successMessage"
  class="mb-6 flex items-center gap-3 bg-emerald-50 border border-emerald-100 text-emerald-700 px-4 py-3 rounded-md text-sm animate-in fade-in duration-300"
>
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="size-5">
    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
  </svg>
  {{ successMessage }}
</div>

<div
  *ngIf="serviceOrder"
  class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 mb-6"
>
  <div class="flex justify-between items-start">
    <div>
      <div class="flex items-center gap-2 mb-1">
        <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded uppercase tracking-wider">
          Ordem de Serviço</span>
        <h3 class="text-lg font-bold text-gray-800">OS {{ serviceOrder.os }}</h3>
      </div>
      <p class="text-sm font-medium text-gray-500">{{ serviceOrder.servico }}</p>
    </div>

    <span
      class="px-3 py-1 rounded-md text-xs font-bold uppercase tracking-wider border shadow-sm"
      [ngClass]="{
        'bg-slate-50 text-slate-600 border-slate-200': serviceOrder.status === 'ABERTO',
        'bg-blue-50 text-blue-700 border-blue-100': serviceOrder.status === 'ATRIBUIDO'        
      }"
    >
      {{ serviceOrder.status.replace('_', ' ') }}
    </span>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-5 gap-6 mt-3 pt-6 border-t border-gray-50">
    <div class="space-y-1">
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-tight">Tipo</p>
      <p class="text-sm font-semibold text-gray-700">{{ serviceOrder.tipo }}</p>
    </div>
    <div class="space-y-1">
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-tight">Prioridade</p>
      <p class="text-sm font-semibold text-gray-700">{{ serviceOrder.prioridade }}</p>
    </div>
    <div class="space-y-1">
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-tight">Prazo</p>
      <p class="text-sm font-semibold text-gray-700">{{ serviceOrder.prazoDias }} dias</p>
    </div>
    <div class="space-y-1">
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-tight">Bairro</p>
      <p class="text-sm font-semibold text-gray-700">{{ serviceOrder.bairro }}</p>
    </div>
    <div class="space-y-1">
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-tight">Valor</p>
      <p class="text-sm font-bold text-gray-700">R$ {{ serviceOrder.valor | number:'1.2-2' }}</p>
    </div>
  </div>
</div>

<form
  class="bg-white rounded-xl shadow-md p-8 border border-gray-200 space-y-8"
  [formGroup]="form"
  (ngSubmit)="concluir()"
>

  <div class="border-b border-gray-100 pb-4">
    <h2 class="text-2xl font-bold text-gray-800 tracking-tight">
      Execução da Ordem de Serviço
    </h2>
    <p class="text-gray-500 text-sm">
      Informe os dados técnicos e observações para encerramento da OS.
    </p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <div class="space-y-2">
      <label class="block text-xs font-semibold text-gray-500 uppercase">
        Retorno de Campo
      </label>
      <select
        formControlName="retornoCampo"
        class="w-full h-11 px-4 border border-gray-300 rounded-md text-sm bg-white cursor-pointer
               focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all"
      >
        <option value="">Selecione o parecer técnico</option>
        <option *ngFor="let retorno of retornosDisponiveis" [value]="retorno">
          {{ retorno }}
        </option>
      </select>
      <p
        *ngIf="form.get('retornoCampo')?.touched && form.get('retornoCampo')?.invalid"
        class="text-[11px] text-red-500 font-medium mt-1 flex items-center gap-1"
      >
        <span class="text-sm">×</span> Parecer técnico é obrigatório para conclusão.
      </p>
    </div>

    <div class="space-y-2">
      <label class="block text-xs font-semibold text-gray-500 uppercase">
        Evidências
      </label>
      <div class="flex items-center gap-4">
        <label
          class="flex items-center gap-2 px-4 py-2 bg-slate-50 border border-gray-300 rounded-md cursor-pointer
                 hover:bg-slate-100 hover:border-blue-300 transition-all text-sm font-bold text-gray-700 shadow-sm"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="size-4 text-blue-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
          </svg>
          Adicionar Fotos
          <input type="file" multiple hidden (change)="onFilesSelected($event)" />
        </label>
        <div class="flex flex-col">
          <span class="text-xs font-bold text-blue-900 leading-none">
            {{ anexos.length }} arquivos
          </span>
          <span class="text-[10px] text-gray-400 uppercase tracking-tighter">Selecionados</span>
        </div>
      </div>
    </div>
  </div>

  <div class="space-y-2">
    <label class="block text-xs font-bold text-gray-500 uppercase">
      Descrição do Serviço Realizado
    </label>
    <textarea
      rows="4"
      formControlName="observacao"
      class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm
             focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder:text-gray-300"
      placeholder="Descreva aqui o que foi realizado."
    ></textarea>
  </div>

  <div class="flex justify-end gap-3 pt-6 border-t border-gray-100">
    <button
      type="button"
      (click)="cancelar()"
      class="px-6 py-2.5 border border-gray-300 text-gray-600 rounded-md font-semibold text-sm
             hover:bg-gray-50 transition-colors"
    >
      Cancelar
    </button>

    <button
      type="submit"
      [disabled]="form.invalid || isConcluding"
      class="px-8 py-2.5 bg-emerald-700 text-white rounded-md font-bold text-sm
             hover:bg-emerald-800 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed
             transition-all shadow-sm flex items-center gap-2"
    >
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="size-4">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
      </svg>
      Efetivar Conclusão
    </button>
  </div>
</form>